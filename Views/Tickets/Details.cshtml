@model SupportDeskAppNew.Models.Ticket
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <!-- Main Ticket Details -->
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="card-title mb-0">
                                <i class="fas fa-ticket-alt me-2"></i>Ticket #@Model.Id
                            </h3>
                            <small class="opacity-75">@Model.Title</small>
                        </div>
                        <div class="text-end">
                            <span class="badge fs-6 bg-@(Model.Status == "Open" ? "success" : Model.Status == "In Progress" ? "warning text-dark" : "secondary")">
                                <i class="fas fa-@(Model.Status == "Open" ? "folder-open" : Model.Status == "In Progress" ? "clock" : "check-circle") me-1"></i>
                                @Model.Status
                            </span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-4">
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <h5 class="text-primary mb-3">
                                <i class="fas fa-info-circle me-2"></i>Ticket Information
                            </h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold text-muted">Title</label>
                                        <div class="p-3 bg-light rounded">
                                            <h6 class="mb-0">@Model.Title</h6>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold text-muted">Priority Level</label>
                                        <div class="p-3 bg-light rounded">
                                            <span class="badge fs-6 px-3 py-2 bg-@(Model.Priority == "High" ? "danger" : Model.Priority == "Medium" ? "warning text-dark" : "secondary")">
                                                <i class="fas fa-@(Model.Priority == "High" ? "exclamation-triangle" : Model.Priority == "Medium" ? "exclamation-circle" : "info-circle") me-1"></i>
                                                @Model.Priority Priority
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-semibold text-muted">Description</label>
                                <div class="p-3 bg-light rounded" style="min-height: 120px;">
                                    @if (!string.IsNullOrEmpty(Model.Description))
                                    {
                                        <p class="mb-0" style="white-space: pre-wrap;">@Model.Description</p>
                                    }
                                    else
                                    {
                                        <p class="text-muted mb-0 fst-italic">No description provided.</p>
                                    }
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold text-muted">Current Status</label>
                                        <div class="p-3 bg-light rounded">
                                            <span class="badge fs-6 bg-@(Model.Status == "Open" ? "success" : Model.Status == "In Progress" ? "warning text-dark" : "secondary")">
                                                <i class="fas fa-@(Model.Status == "Open" ? "folder-open" : Model.Status == "In Progress" ? "clock" : "check-circle") me-1"></i>
                                                @Model.Status
                                            </span>
                                            @if (Model.Status == "Open")
                                            {
                                                <small class="d-block text-muted mt-1">Awaiting review by support team</small>
                                            }
                                            else if (Model.Status == "In Progress")
                                            {
                                                <small class="d-block text-muted mt-1">Currently being worked on</small>
                                            }
                                            else if (Model.Status == "Closed")
                                            {
                                                <small class="d-block text-muted mt-1">Issue resolved and completed</small>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold text-muted">Created Date</label>
                                        <div class="p-3 bg-light rounded">
                                            <i class="fas fa-calendar-alt me-2"></i>
                                            <strong>@Model.Created.ToString("dddd, dd MMMM yyyy")</strong>
                                            <br>
                                            <small class="text-muted">at @Model.Created.ToString("HH:mm")</small>
                                            <br>
                                            <small class="text-muted">(@(DateTime.Now.Subtract(Model.Created).Days) days ago)</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="d-flex flex-wrap gap-2 justify-content-between">
                        <div>
                            <a class="btn btn-outline-secondary" asp-action="Index">
                                <i class="fas fa-arrow-left me-2"></i>Back to List
                            </a>
                        </div>
                        <div>
                            <a class="btn btn-primary" asp-action="Edit" asp-route-id="@Model.Id">
                                <i class="fas fa-edit me-2"></i>Edit Ticket
                            </a>
                            @if (Model.Status != "Closed")
                            {
                                <button type="button" class="btn btn-success" onclick="quickStatusUpdate(@Model.Id, 'Closed')">
                                    <i class="fas fa-check me-2"></i>Mark as Closed
                                </button>
                            }
                            else
                            {
                                <button type="button" class="btn btn-warning" onclick="quickStatusUpdate(@Model.Id, 'Open')">
                                    <i class="fas fa-redo me-2"></i>Reopen Ticket
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar with Additional Info -->
        <div class="col-md-4">
            <!-- Quick Actions Card -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        @if (Model.Status == "Open")
                        {
                            <button type="button" class="btn btn-warning" onclick="quickStatusUpdate(@Model.Id, 'In Progress')">
                                <i class="fas fa-play me-2"></i>Start Working
                            </button>
                        }
                        @if (Model.Status == "In Progress")
                        {
                            <button type="button" class="btn btn-success" onclick="quickStatusUpdate(@Model.Id, 'Closed')">
                                <i class="fas fa-check me-2"></i>Mark Complete
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="quickStatusUpdate(@Model.Id, 'Open')">
                                <i class="fas fa-pause me-2"></i>Put on Hold
                            </button>
                        }
                        @if (Model.Status == "Closed")
                        {
                            <button type="button" class="btn btn-warning" onclick="quickStatusUpdate(@Model.Id, 'In Progress')">
                                <i class="fas fa-redo me-2"></i>Reopen & Resume
                            </button>
                        }
                        <hr>
                        <a href="mailto:support@company.com?subject=Regarding Ticket #@Model.Id&body=Ticket: @Model.Title%0A%0A" class="btn btn-outline-info">
                            <i class="fas fa-envelope me-2"></i>Email Support
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Ticket Metadata -->
            <div class="card shadow mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info me-2"></i>Ticket Metadata
                    </h5>
                </div>
                <div class="card-body">
                    <div class="small">
                        <div class="mb-3">
                            <strong>Ticket ID:</strong><br>
                            <code>#@Model.Id</code>
                        </div>
                        <div class="mb-3">
                            <strong>Age:</strong><br>
                            @{
                                var age = DateTime.Now.Subtract(Model.Created);
                                var ageText = age.Days > 0 ? $"{age.Days} days, " : "";
                                ageText += $"{age.Hours} hours, {age.Minutes} minutes";
                            }
                            @ageText
                        </div>
                        <div class="mb-3">
                            <strong>Expected Response:</strong><br>
                            @switch (Model.Priority)
                            {
                                case "High":
                                    <span class="text-danger">Within 2 hours</span>
                                    break;
                                case "Medium":
                                    <span class="text-warning">Within 24 hours</span>
                                    break;
                                default:
                                    <span class="text-secondary">Within 3 days</span>
                                    break;
                            }
                        </div>
                        <div class="mb-0">
                            <strong>Last Updated:</strong><br>
                            @DateTime.Now.ToString("dd-MM-yyyy HH:mm")
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Help & Resources -->
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-question-circle me-2"></i>Need Help?
                    </h5>
                </div>
                <div class="card-body">
                    <div class="small">
                        <p class="mb-3">
                            <strong>Emergency Support:</strong><br>
                            <a href="tel:1-800-SUPPORT" class="text-decoration-none">
                                <i class="fas fa-phone me-1"></i>1-800-SUPPORT
                            </a>
                        </p>
                        <p class="mb-3">
                            <strong>Knowledge Base:</strong><br>
                            <a href="#" class="text-decoration-none">
                                <i class="fas fa-book me-1"></i>Browse Articles
                            </a>
                        </p>
                        <p class="mb-0">
                            <strong>Community Forum:</strong><br>
                            <a href="#" class="text-decoration-none">
                                <i class="fas fa-users me-1"></i>Ask Community
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Ticket Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to change the status of this ticket to "<span id="newStatusText"></span>"?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatusUpdate">Confirm Update</button>
            </div>
        </div>
    </div>
</div>

<script>
    let pendingStatusUpdate = null;
    
    function quickStatusUpdate(ticketId, newStatus) {
        pendingStatusUpdate = { ticketId, newStatus };
        document.getElementById('newStatusText').textContent = newStatus;
        new bootstrap.Modal(document.getElementById('statusUpdateModal')).show();
    }
    
    document.getElementById('confirmStatusUpdate').addEventListener('click', function() {
        if (!pendingStatusUpdate) return;
        
        const { ticketId, newStatus } = pendingStatusUpdate;
        
        fetch('/Tickets/QuickStatusUpdate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            },
            body: JSON.stringify({
                id: ticketId,
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message and reload page
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show';
                alert.innerHTML = `
                    <i class="fas fa-check-circle me-2"></i>${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.container').insertBefore(alert, document.querySelector('.row'));
                
                // Reload page after short delay
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                throw new Error('Update failed');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>Failed to update status. Please try again.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.row'));
        })
        .finally(() => {
            bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal')).hide();
            pendingStatusUpdate = null;
        });
    });
</script>